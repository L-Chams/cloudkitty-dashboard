{% load i18n %}
<div class="grouping-options">
    <h4>Group by:</h4>
    <!--checkbox filtering-->
    <form method="GET" action="?" id="groupby_checkbox" class="form-inline">
        <section>
            <label for="id" class="group-label">
                <input type="checkbox" name="id" value="true" id="checkbox-id"> ID
            </label>
            <label for="user_id" class="group-label">
                <input type="checkbox" name="user_id" value="true" id="checkbox-user_id"> User ID
            </label>
            <label for="project_id" class="group-label">
                <input type="checkbox" name="project_id" value="true" id="checkbox-project_id"> Project ID
            </label>
            <button class="btn btn-primary" id="toggleAll" type="button" onclick="toggleAllCheckboxes()">
                {% trans "Select All" %}
            </button>
        </section>
        <button class="btn btn-primary" type="submit">{% trans "Submit" %}</button>
    </form>
</div>

<script>
    const checkboxes = ['id', 'user_id', 'project_id'];

    // Function to update the button text based on checkbox states
    function updateButtonText() {
        const allCheckboxes = document.querySelectorAll('.group-label input[type=checkbox]');
        const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
        const button = document.getElementById('toggleAll');
        button.textContent = allChecked ? "{% trans 'Unselect All' %}" : "{% trans 'Select All' %}";
    }

    // Function to toggle all checkboxes and update session storage
    function toggleAllCheckboxes() {
        const allCheckboxes = document.querySelectorAll('.group-label input[type=checkbox]');
        const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);

        allCheckboxes.forEach(cb => {
            cb.checked = !allChecked;
            sessionStorage.setItem(cb.id, cb.checked);
        });

        updateButtonText();

        // Submit the form
        document.getElementById('groupby_checkbox').submit();
    }

    document.addEventListener('DOMContentLoaded', function () {
        const urlParams = new URLSearchParams(window.location.search);

        checkboxes.forEach(function (name) {
            const checkbox = document.getElementById('checkbox-' + name);
            if (!checkbox) return;

            // Restore state: URL params take priority, then session storage
            if (urlParams.has(name)) {
                checkbox.checked = urlParams.get(name) === 'true';
            } else {
                const saved = sessionStorage.getItem('checkbox-' + name);
                if (saved) checkbox.checked = saved === 'true';
            }

            // Save state on change
            checkbox.addEventListener('change', function () {
                sessionStorage.setItem('checkbox-' + name, checkbox.checked);
                updateButtonText();
            });
        });

        // Set initial button text
        updateButtonText();
    });
</script>