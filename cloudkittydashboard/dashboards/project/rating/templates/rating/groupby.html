{% load i18n %}
<form method="GET" action="?" id="groupby_checkbox" class="form-inline">
  <h4>{% trans "Group by:" %}</h4>
  <!--checkbox filtering-->
  <div id="checkboxes"></div>
  <button class="btn btn-primary" id="toggleAll" type="button" onclick="toggleAllCheckboxes()">
    {% trans "Select All" %}
  </button>
  <button class="btn btn-primary" type="submit">{% trans "Submit" %}</button>
</form>

<script>
  const groupby = ['type', 'id', 'user_id', 'project_id'];
  const checkboxes = document.getElementById('checkboxes');
  const urlParams = new URLSearchParams(window.location.search);

  // Function to convert field names to readable format
  function convertString(word) {
    return word.replace(/_/g, ' ')
      .replace(/\b\w/g, l => l.toUpperCase())
      .replace(/\bId\b/g, 'ID');
  }

  let shouldAutoSubmit = false;

  //dynamically create checkboxes based on groupby fields
  groupby.forEach(function (name) {

    // Create checkbox
    const checkbox = document.createElement("input");
    checkbox.type = "checkbox";
    checkbox.name = name;
    checkbox.id = 'checkbox-' + name;
    checkbox.value = "true";
    checkbox.className = "group-checkbox";

    // Create label
    const label = document.createElement("label");
    label.htmlFor = 'checkbox-' + name;
    label.className = "group-label";
    label.appendChild(checkbox);
    label.appendChild(document.createTextNode(' ' + convertString(name)));

    // Add to DOM
    checkboxes.appendChild(label);

    //checkbox state management
    if (urlParams.has(name)) {
      checkbox.checked = (urlParams.get(name) === 'true');
    } else if (urlParams.toString()) {
      checkbox.checked = false;
    } else {
      // No URL params - restore from sessionStorage or use defaults
      const savedState = sessionStorage.getItem('checkbox-' + name);

      if (savedState !== null) {
        // Use previously saved state
        checkbox.checked = (savedState === 'true');
      } else {
        // Default: only 'type' checkbox is checked initially
        checkbox.checked = (name === 'type');
      }

      // Mark for auto-submit if any checkbox will be checked
      if (checkbox.checked) {
        shouldAutoSubmit = true;
      }
    }

    // Save current state and add change listener
    sessionStorage.setItem('checkbox-' + name, checkbox.checked);
    checkbox.addEventListener('change', function () {
      sessionStorage.setItem(this.id, this.checked);
      updateButtonText();
    });
  });

  // Set initial button text
  updateButtonText();

  // Auto-submit logic: if no URL params exist but we can restore based off sessionStorage
  if (shouldAutoSubmit) {
    document.getElementById('groupby_checkbox').submit();
  }

  // Function to update the button text based on checkbox states
  function updateButtonText() {
    const allCheckboxes = document.querySelectorAll('.group-checkbox');
    const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);
    const button = document.getElementById('toggleAll');
    button.textContent = allChecked ? "{% trans 'Unselect All' %}" :
     "{% trans 'Select All' %}";
  }

  // Function to toggle all checkboxes and update session storage
  function toggleAllCheckboxes() {
    const allCheckboxes = document.querySelectorAll('.group-checkbox');
    const allChecked = Array.from(allCheckboxes).every(cb => cb.checked);

    allCheckboxes.forEach(cb => {
      cb.checked = !allChecked;
      sessionStorage.setItem(cb.id, cb.checked);
    });

    updateButtonText();
    document.getElementById('groupby_checkbox').submit();
  }
</script>

<style>
  /* Align form and controls with the left edge of the graph */
  .form-inline {
    text-align: left;
    margin-left: 0;
    padding-left: 0;
    margin: 0;
    padding: 0;
  }

  .form-inline h4 {
    text-align: left;
    margin-left: 0;
    padding-left: 0;
    margin-top: 0;
    margin-bottom: 10px;
  }

  .form-inline #checkboxes {
    margin-bottom: 10px;
  }

  .form-inline .btn {
    margin-left: 0;
    margin-right: 10px;
    margin-bottom: 10px;
  }

  .group-label {
    display: inline-block;
    margin-right: 8px;
    margin-bottom: 5px;
    font-weight: normal;
  }

  .group-checkbox {
    margin-right: 5px;
  }

  button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }
</style>